---
sidebar_label: Exceptions
sidebar_position: 1
description: Les exceptions en Python
---

# Les exceptions

Les exceptions sont un m√©canisme de gestion des erreurs et des √©v√©nements
impr√©vus qui se produisent durant l'ex√©cution d'un programme. Elles permettent de
:

- **Isoler** le code de traitement normal du code de gestion des erreurs.
- **Propager** les erreurs √† un niveau sup√©rieur sans casser l‚Äôex√©cution compl√®te du programme.
- **Centraliser** la gestion des erreurs pour la rendre plus lisible et maintenable.

Sans exceptions, il faudrait v√©rifier manuellement chaque op√©ration susceptible
d‚Äô√©chouer (lecture de fichier, conversion de type, acc√®s √† un index hors
limites, etc.), ce qui alourdirait consid√©rablement le code et le rendrait
vuln√©rable aux oublis.

## Lever une exception

Lorsqu'une erreur se produit, il est possible de lever une exception. En Python,
cela se fait avec le mot-cl√© `raise`. Par exemple, vous pouvez lever une
`ZeroDivisionError` de la mani√®re suivante :

```python
# Exemple de lev√©e d'une exception
def division(a, b):
    if b == 0:
        raise ZeroDivisionError("Division par z√©ro !")
    return a / b

print(division(10, 2))  # Affiche 5.0
print(division(10, 0))  # L√®ve ZeroDivisionError
```

Il est important de noter que lever une exception interrompt l'ex√©cution
normale du programme. Le code apr√®s la lev√©e de l'exception ne sera pas ex√©cut√©
et le programme se terminera √† moins que l'exception ne soit attrap√©e.

## Attraper une exception

Lorsqu'une exception est lev√©e, elle peut √™tre attrap√©e et g√©r√©e √† l'aide d'un
bloc `try/except`. Le bloc `try` contient le code qui peut lever une exception, et le bloc
`except` contient le code qui g√®re l'exception. Voici un exemple simple :

```python
try:
    result = division(10, 0)
except ZeroDivisionError as e:
    print("Erreur d√©tect√©e :", e)
```

Il existe aussi la syntaxe `else` et `finally` pour g√©rer les exceptions de
mani√®re plus fine. Le bloc `else` s'ex√©cute si aucune exception n'est lev√©e, et le bloc `finally` s'ex√©cute
toujours, qu'une exception soit lev√©e ou non. Voici un exemple :

```python
try:
    result = division(10, 2)
except ZeroDivisionError as e:
    print("Erreur d√©tect√©e :", e)
else:
    print("R√©sultat :", result)
finally:
    print("Fin du traitement.")
```

Le code ci-dessus affichera "R√©sultat : 5.0" et "Fin du traitement." si une
exception n'est pas lev√©e. Si une exception est lev√©e, il affichera "Erreur
d√©tect√©e : Division par z√©ro !" et "Fin du traitement.".

En r√©sum√©, 

* **`try`** : zone o√π l‚Äôon place le code √† risque.
* **`except ExceptionType as e`** : sert √† capturer l‚Äôexception et lier l‚Äôobjet √† la variable `e`.
* **`else`** (optionnel) : ex√©cut√© si aucune exception n‚Äôest lev√©e.
* **`finally`** (optionnel) : ex√©cut√© toujours, que l‚Äôexception soit lev√©e ou non.

## La hi√©rarchie des exceptions

Toutes les exceptions h√©ritent de la classe de base `BaseException`. Les plus courantes h√©ritent de `Exception`.
Voici un aper√ßu de la [hi√©rarchie des exceptions](https://docs.python.org/3/library/exceptions.html) en Python.

```
BaseException
 ‚îú‚îÄ‚îÄ SystemExit
 ‚îú‚îÄ‚îÄ KeyboardInterrupt
 ‚îî‚îÄ‚îÄ Exception
      ‚îú‚îÄ‚îÄ StopIteration
      ‚îú‚îÄ‚îÄ ArithmeticError
      ‚îÇ    ‚îú‚îÄ‚îÄ ZeroDivisionError
      ‚îÇ    ‚îî‚îÄ‚îÄ OverflowError
      ‚îú‚îÄ‚îÄ LookupError
      ‚îÇ    ‚îú‚îÄ‚îÄ IndexError
      ‚îÇ    ‚îî‚îÄ‚îÄ KeyError
      ‚îú‚îÄ‚îÄ ValueError
      ‚îú‚îÄ‚îÄ TypeError
      ‚îî‚îÄ‚îÄ ... (et bien d'autres)
```

Il n'est pas recommand√© d'attraper `BaseException`, car cela inclut des
exceptions syst√®me comme `SystemExit` et `KeyboardInterrupt`, qui ne sont pas
des erreurs de programme. Il est pr√©f√©rable d'attraper des exceptions
sp√©cifiques, comme `ValueError`, `TypeError`, etc. Pour une exception
g√©n√©rique, vous pouvez utiliser `Exception`.

## Attraper plusieurs types d‚Äôexceptions

Il est possible d'attraper plusieurs types d'exceptions en les s√©parant par des
virgules dans le bloc `except`. Il est √©galement possible d'utiliser plusieurs
blocs `except` pour g√©rer diff√©rents types d'exceptions de mani√®re distincte.

```python
try:
    # code pouvant lever diff√©rentes erreurs
    valeur = liste[10]
    x = int("abc")
except (IndexError, KeyError) as e:
    print("Erreur de lookup :", e)
except ValueError:
    print("Impossible de convertir en entier.")
except Exception as e:
    print("Autre erreur d√©tect√©e :", type(e).__name__, e)
```

:::warning

L‚Äôordre des `except` compte : du plus pr√©cis au plus g√©n√©ral. Une fois dans un
`except`, les suivants ne seront pas test√©s.

:::

## Cr√©er ses propres exceptions

Il est courant de d√©finir des exceptions personnalis√©es pour votre domaine m√©tier.
Cela permet de mieux g√©rer les erreurs sp√©cifiques √† votre application et de
fournir des messages d'erreur plus clairs. Bien que nous n'ayons pas encore
vu la notion de classes, la syntaxe est relativement simple :

```python
class MyError(Exception):
    """Exception lev√©e pour un cas sp√©cifique de mon application."""
    pass


def fonction_critique(x):
    if x < 0:
        raise MyError("x doit √™tre positif")
    return x * 2

try:
    fonction_critique(-5)
except MyError as e:
    print("Erreur m√©tier :", e)
```

Voici quelques bonnes pratiques pour cr√©er vos propres exceptions :

* **H√©riter** toujours de `Exception` (et non de `BaseException`).
* **Nommer** vos exceptions avec le suffixe `Error`.
* **Documenter** clairement les conditions de lev√©e.

## G√©rer les ressources avec `with ‚Ä¶ as`

Le mot-cl√© `with ‚Ä¶ as` simplifie la gestion des ressources (fichiers,
connexions r√©seau, verrous, etc.) en garantissant que les op√©rations
d‚Äôinitialisation et de nettoyage sont toujours ex√©cut√©es, *m√™me en cas
d‚Äôexception*.

Voici comment fonctionne `with` :

1. L‚Äôexpression apr√®s `with` est affect√©e √† la variable apr√®s `as`. Cette
   expression doit retourner un objet qui impl√©mente notamment la m√©thode
   `__exit__`. Nous verrons plus tard comment cr√©er de tels objets.
2. Ex√©cution du bloc indent√©
3. Si une exception est lev√©e, le bloc `__exit__` de l‚Äôobjet est appel√© avec
   l‚Äôexception comme argument.
4. Si aucune exception n‚Äôest lev√©e, le bloc `__exit__` est appel√© avec `None` comme
   valeur d‚Äôexception.

Donc dans tous les cas, la m√©thode `__exit__` est appel√©e, ce qui permet de
lib√©rer les ressources correctement.

Par exemple, l'usage de `with` est particuli√®rement courant pour la gestion de fichiers. Voici
comment ouvrir fichier en mode lecture :

```
with open("data.txt", "r") as f:
    contenu = f.read()
# Ici, f.close() a √©t√© appel√© automatiquement, m√™me en cas d‚Äôerreur.
```

Sans `with`, il faudrait √©crire :

```
f = open("data.txt", "r")
try:
    contenu = f.read()
finally:
    f.close()
```

Il est facile d'oublier de fermer le fichier dans le bloc `finally`, ce qui peut
entra√Æner des fuites de ressources. Avec `with`, cela est g√©r√© automatiquement.

## Cha√Ænage d‚Äôexceptions et `raise from`

Il arrive que vous souhaitiez lever une nouvelle exception en r√©ponse √† une
autre. Ceci est particuli√®rement utile pour encapsuler des exceptions de bas
niveau dans des exceptions de plus haut niveau, tout en conservant la trace de
l'exception d'origine. Cela permet d'ajouter du contexte √† l'erreur et facilite
le d√©bogage.

Ainsi, lorsque vous attrapez une exception pour en lancer une autre, utilisez `raise
... from ...` pour conserver la trace :

```python
class MyError(Exception):
    pass

try:
    open("/chemin/inexistant.txt")
except FileNotFoundError as e:
    raise MyError("√âchec du stockage : fichier introuvable") from e
```

Le `from e` √† la fin permet de lier l'exception d'origine √† la nouvelle
exception. Ainsi, lorsque vous affichez l'erreur, vous verrez la cha√Æne d'exceptions
compl√®te, ce qui facilite le d√©bogage.

## Quand **ne pas** utiliser les exceptions

Il arrive parfois que l'utilisation d'exceptions ne soit pas la meilleure
solution. Voici quelques cas o√π il est pr√©f√©rable d'√©viter les exceptions :

1. **Contr√¥le de flux pr√©visible** : Par exemple lorsque vous savez √† l‚Äôavance qu‚Äôune valeur peut √™tre `None` ou hors plage.

   ```python
   # Mauvais
   try:
       longueur = len(texte)
   except TypeError:
       longueur = 0

   # Meilleur : test explicite
   if texte is None:
       longueur = 0
   else:
       longueur = len(texte)
   ```

2. **Performance critique ou boucles intensives** : La lev√©e d‚Äôune exception
   est **co√ªteuse** en termes de performances. Si vous devez effectuer une
    op√©ration r√©p√©t√©e, il est pr√©f√©rable d'utiliser des tests pr√©alables.

   ```python
   # Mauvais : lev√©e d'exception dans une boucle
   for i in range(1000000):
       try:
           result = division(i, 0)
       except ZeroDivisionError:
           pass

   # Meilleur : test pr√©alable
   for i in range(1000000):
       if i != 0:
           result = division(i, 0)
   ```

## Testez votre compr√©hension

<details>
<summary>üí™ Exercices</summary>

<ExerciseTabs>

<Exercise >
  <ExerciseHeader>
  √âcire un programme qui parcours la liste ["1", "2", "abc", "4", "5.xyz"] et tenter de convertir chaque √©l√©ment en entier.
  Essayer d'attraper l'exception la plus sp√©cifique possible.
  </ExerciseHeader>
  <ExerciseBody>
    ```python
    liste = ["1", "2", "abc", "4", "5.xyz"]
    # ... votre code ici
    ```
   </ExerciseBody>
</Exercise>

<Exercise >
  <ExerciseHeader>
    √âcrire un programme qui prend une liste de paires  
    `[(10, 2), (5, 0), (7, "a"), (8, 4)]` et tente de calculer la division a / b
    pour chaque couple `(a, b)`.  
    Attraper les exceptions les plus sp√©cifiques possibles.
  </ExerciseHeader>
  <ExerciseBody>
    ```python
    paires = [(10, 2), (5, 0), (7, "a"), (8, 4)]
    for a, b in paires:
        # ... votre code ici
    ```
  </ExerciseBody>
</Exercise>

<Exercise >
  <ExerciseHeader>
    √âcrire un programme qui parcourt la liste  
    `[[1, 2], [3], [], [4, 5, 6]]` et tente d‚Äôafficher le deuxi√®me √©l√©ment
    de chaque sous-liste.  
    Attraper les exceptions les plus sp√©cifiques possibles.
  </ExerciseHeader>
  <ExerciseBody>
    ```python
    listes = [[1, 2], [3], [], [4, 5, 6]]
    for sous_liste in listes:
        # ... votre code ici
    ```
  </ExerciseBody>
</Exercise>

</ExerciseTabs>

</details>